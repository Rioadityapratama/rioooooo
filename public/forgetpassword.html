<!DOCTYPE html>
<html>
  <head>
    <title>Forget Password (2-step Validation)</title>
    <style>
      input {
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <h2>Forget Password</h2>

    <!-- STEP 1: Form Cek Email -->
    <div id="step1">
      <input type="email" id="email" placeholder="Masukkan Email" required /><br />
      <button onclick="checkEmail()">Cek Email</button>
    </div>

    <!-- STEP 2: Form Ganti Password -->
    <div id="step2" style="display: none">
      <input type="password" id="new_password" placeholder="Password Baru" required /><br />
      <button onclick="resetPassword()">Ganti Password</button>
    </div>

    <div id="result"></div>

    <script>
      async function checkEmail() {
        const email = document.getElementById('email').value;

        const query = `
        query {
          users {
            email
          }
        }
      `;

        const res = await fetch('http://localhost:8080/graphql', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query }),
        });

        const data = await res.json();

        if (data.errors) {
          result.innerText = '❌ Error: ' + data.errors[0].message;
          return;
        }

        const users = data.data.users;
        const found = users.find((user) => user.email === email);

        if (found) {
          result.innerText = '✅ Email ditemukan, silakan masukkan password baru.';
          document.getElementById('step1').style.display = 'none';
          document.getElementById('step2').style.display = 'block';
        } else {
          result.innerText = '❌ Email tidak ditemukan.';
        }
      }

      async function resetPassword() {
        const email = document.getElementById('email').value;
        const new_password = document.getElementById('new_password').value;

        const query = `
        mutation {
          forgetPassword(
            email: "${email}",
            new_password: "${new_password}"
          )
        }
      `;

        const res = await fetch('http://localhost:8080/graphql', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query }),
        });

        const data = await res.json();

        if (data.errors) {
          result.innerText = '❌ Error: ' + data.errors[0].message;
        } else {
          result.innerText = '✅ ' + data.data.forgetPassword;
          document.getElementById('step2').style.display = 'none';
        }
      }
    </script>
  </body>
</html>
